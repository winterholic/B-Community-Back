<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bjt.gallery.repository.PostMapper">

    <!-- 게시글 목록 조회 (페이징, 정렬) -->
    <select id="findPostList" resultType="com.bjt.gallery.dto.response.PostListResponse">
        SELECT
            p.id AS id,
            p.title AS title,
            p.tag AS tag,
            SUBSTRING(p.author_hash, 1, 7) AS authorHash,
            (p.upvote_count - p.downvote_count) AS voteScore,
            COALESCE(comment_counts.cnt, 0) AS commentCount,
            p.created_at AS createdAt,
            SUBSTRING(REGEXP_REPLACE(p.content, '&lt;[^&gt;]*&gt;', ''), 1, 100) AS contentPreview
        FROM posts p
        LEFT JOIN (
            SELECT post_id, COUNT(*) AS cnt
            FROM comments
            WHERE is_deleted = false
            GROUP BY post_id
        ) comment_counts ON p.id = comment_counts.post_id
        WHERE p.is_deleted = false
        <choose>
            <when test="sortType == 'popular'">
                ORDER BY voteScore DESC, p.created_at DESC
            </when>
            <otherwise>
                ORDER BY p.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <!-- 게시글 검색 (제목 or 내용) -->
    <select id="searchPosts" resultType="com.bjt.gallery.dto.response.PostListResponse">
        SELECT
            p.id AS id,
            p.title AS title,
            p.tag AS tag,
            SUBSTRING(p.author_hash, 1, 7) AS authorHash,
            (p.upvote_count - p.downvote_count) AS voteScore,
            COALESCE(comment_counts.cnt, 0) AS commentCount,
            p.created_at AS createdAt,
            SUBSTRING(REGEXP_REPLACE(p.content, '&lt;[^&gt;]*&gt;', ''), 1, 100) AS contentPreview
        FROM posts p
        LEFT JOIN (
            SELECT post_id, COUNT(*) AS cnt
            FROM comments
            WHERE is_deleted = false
            GROUP BY post_id
        ) comment_counts ON p.id = comment_counts.post_id
        WHERE p.is_deleted = false
          AND (p.title LIKE CONCAT('%', #{keyword}, '%')
           OR p.content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY p.created_at DESC
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <!-- 게시글의 댓글 수 조회 -->
    <select id="countCommentsByPostId" resultType="Long">
        SELECT COUNT(*)
        FROM comments
        WHERE post_id = #{postId}
          AND is_deleted = false
    </select>

</mapper>
